using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization.Json;
using System.Security.Cryptography;
using System.Text;
using testThreadAlongMainWebTread.Util;

namespace Helper.UIHelper
{
    public class CaptchaKeySpec
    {
        public static Models.CapthcaKeySpec KeySpec { get; set; }
        private static RSACryptoServiceProvider Signer { get; set; }
        private static RSACryptoServiceProvider Verifier { get; set; }
        static CaptchaKeySpec()
        {

            if (KeySpec != null) return;

            KeySpec = new Models.CapthcaKeySpec
            {
                PrivateKey = "D928A3B51A3E9E4F125194B3F2CABBA1ADDBEE94A043430321961E88955E21C99FD6FDB5BE8F0D257122474F5B7407EDCEEC63EE8790F6DF3090073040C906A88B0C3F0FB76C6E06C8818FE0EDB652D178BBDF1712A9CCF5B4BA05F655929C01E038CA266990A9538EE539D7F7FC8A6AD757C1489C024902FF8A62189659764D0A1D7D1396D885B5E00CCACE937C54C33A0C798AC362207397DB9A6471B69D2D29B94CB925A1E3B4A21819DC6B8382661100F0A86AE5439F16739DFC26B4F12C1BA77866E45F79253015BB418C9785E712789B4C547E2C6DDD89A26DDC05D4BE4EEC435B258F1CE9D7C0CE187A03994B41186D11A97285FEE3B8ADFDE641C4D61369444E5792699CB479CF0DFB1AA504ADCD0A21BF002D09DA3BF45950BD2B24A139AFEA80C89121EE630D52145359B36ABCE9CEC9275CA0C6968C525ABC171D8CE6A4D0F4DC20605941B2BC7EA4B1BE47AF3ADC9B155C1780B14831DCB3D86356460AA132009BA799793F01F4847E415CE58BCEAEABE0ED45C5FC71240AAE1F14BC5767C9EA1F0904E8FE40E4025203584AA63CAAE6FC655B237B97CE0D44D608765FF24597E8FC8F243CAF723419FA4B723F9AABDC99A2B7D6B92C05A1D75FB352AA97B332C74180C3A2B90242847659812F82077E64F21656AAEDE9E0A47948868C1BB448A18840081A7DA6F6B06211552EB7ECC7C78F118D04D6BF74FB20CB282D56FC8EA9220502AC05459A3E10129B76D619D0AF4D960D9B670679EE77E0A066B7B0AFA814DF8DCFD79CAD6A9B37D4781799DB009B6FD247600AA7E7C4B4C141783784BD0DBA13384FC2C93E29437D2057BC434F3FF29AE014802F052927F746B5FC7563F2EE821DCEE6572997DD0051A88653FEBE276382E0417CEF3480ACC505C8E966E750C4E7DA63040750D6066A8CF0050FC3D349035AC5B664E2B23DAD581F4AAC7906A3F3687DEF456B01753F4ECCA2B9157B76D0837EA81E7D61B220335B4C0832459850463588022F8C91359A26F7DF70208733D64FD52AD6C051E36552C7A5C7676C4C3A0A9417E1A7CBFE440950A8E034153EFA07BA0240402FA77A4D2022C53139B09DA991223930FDAD14EF6BF9609C87AA9C67A798B65508BB50C657DAE34163FFBA8C1271FCEB826780BAD48AE6DA2557092153CB543B4537D6DE33998DDA7D7508D154DB59F6CEFD6EB4CADA280458406CB4EEADFB887422985193FFA5BC1386F47D9C0D009872B6B4CFB46CC1BB82925D408E0E78",
                PublicKey = "D928A3B51A3E9E4FC107FD6C26BDA9F5A9FA1D581EBB28E9F063323264B29B7DCC1CEFF2D39E747CB78A907A6808C61DB0E399039FD66CB5F08F14811FF9E394232338D0225ACE4E7E498928ED2813ADBA53F8203BA369D083CF8EA4327B999143F7FD00C1CCFCF6A216B642D0592B119A847439788D5EEEFD594296A66ECCC0F321DCBF7FB8BD68D7D3F59C2F4B8783A34D05025A66A54280168FD0A825784AA43CE928994668F83C5AE69E06B49A1A0C7DAF9B6E55DCC0AE25BEDE6BECED5C179035AF161CF528EAA98EFAD4D4574C91F3E3E87E62153142822029108C0415447C141B4FD4CDBCADE52E12114B8766F5A684685F35229B62A51052C5992461CFC8BB14D77D1E5728367C12F9AFF32A"
            };

            var configFile = $"{AppDomain.CurrentDomain.BaseDirectory}/config/captchaKeySpec.cfg";
            if (!Directory.Exists(path: $"{AppDomain.CurrentDomain.BaseDirectory}/config/"))
                Directory.CreateDirectory(path: $"{AppDomain.CurrentDomain.BaseDirectory}/config/");


            byte[] buffer;
            if (!File.Exists(configFile))
            {
                using (var stream = new FileStream(configFile, FileMode.Create, FileAccess.Write, FileShare.Read))
                {
                    buffer = KeySpec.ToJson();
                    stream.Write(buffer, offset: 0, count: buffer.Length);
                }
            }
            else
            {
                buffer = File.ReadAllBytes(configFile);
                KeySpec = buffer.FromJson<Models.CapthcaKeySpec>();
            }

            KeySpec.PrivateKey = KeySpec.PrivateKey.DcrCBCPKCS5FromHexString();
            KeySpec.PublicKey = KeySpec.PublicKey.DcrCBCPKCS5FromHexString();

            Signer = new RSACryptoServiceProvider();
            Signer.ImportPrivateKey(KeySpec.PrivateKey);
            Verifier = new RSACryptoServiceProvider();
            Verifier.ImportPublicKey(KeySpec.PublicKey);
        }

        public static string SignCaptcha(string token, string captchaCode)
            => Signer.SignData($"{token}{captchaCode.PadLeft(6, '0')}".HexStringToByteArray(), new SHA256CryptoServiceProvider()).ByteArrayToHexString();
        public static bool VerifyCaptchaSign(string token, string captchaCode, string SignedData)
            => Verifier.VerifyData($"{token}{captchaCode.PadLeft(6, '0')}".HexStringToByteArray(), new SHA256CryptoServiceProvider(), SignedData.HexStringToByteArray());
    }
}
